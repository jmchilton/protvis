#!/bin/sh

config="config.mk"
includes=""
libs=""

usage() {
	cat <<%%%
--include=<dir>   add include directory to search path
--lib=<dir>       add library directory ro search path
%%%
}

cpptestinc() {
	echo -n "Searching for $1 headers: "
	shift
	for i in $@; do
		cat > __test.cpp <<%%%
#include <$i>
int main() { return 0; }
%%%
		$cpp __test.cpp -c -o __test.o $incdirs $libdirs 2>/dev/null 1>/dev/null
		if [ $? -eq 0 ] && [ -e __test.o ]; then
			echo "$i"
			includes="$includes $i"
			rm __test.cpp __test.o 2>/dev/null
			return
		fi
	done
	echo "(Not found)"
	echo "Tried: $*"
	rm __test.cpp 2>/dev/null
	exit 2
}

cpptestlib() {
	echo -n "Searching for $1 library: "
	rm -f __test.cpp 2>/dev/null
	for i in $2; do
		echo "#include <$i>" >> __test.cpp
	done
	echo "int main() { return 0; }" >> __test.cpp
	shift 2
	for i in $@; do
		$cpp __test.cpp -o __test.o $incdirs $libdirs $i 2>/dev/null 1>/dev/null
		if [ $? -eq 0 ] && [ -e __test.o ]; then
			echo "$i"
			libs="$libs $i"
			rm __test.cpp __test.o 2>/dev/null
			return
		fi
	done
	echo "(Not found)"
	echo "Tried: $*"
	rm __test.cpp 2>/dev/null
	exit 2
}

findtool() {
	var=$1
	echo -n "Searching for $2: "
	shift 2
	for i in $@; do
		if [ "`which $i`" != "" ]; then
			echo $i
			echo "$var=$i" >> $config
			return
		fi
	done
	echo "(Not found)"
	echo "Tried: $*"
	exit 2
}

findtool2() {
	for i in $@; do
		if [ "`which $i`" != "" ]; then
			echo $i
			return
		fi
	done
}

incdirs=""
libdirs=""

for arg in $@; do
	case "$arg" in
		--include=*) incdirs="$incdirs -I`echo "$arg" | cut -b 11-`";;
		--lib=*) libdirs="$libdirs -L`echo "$arg" | cut -b 7-`";;
		*)
			echo "Unrecognised option '$arg'"
			usage
			exit 1;;
	esac
done

rm $config 2>/dev/null
echo -n "Searching for C++ compiler: "
cpp=`findtool2 g++ gpp`
if [ "x$cpp" != "x" ]; then
	echo $cpp
	echo "CC=$cpp" >> $config
else
	echo "(Not found)"
	exit
fi

cpptestinc "python" "Python.h" "python`../env/bin/python --version 2>&1 | awk '{print $2}' | cut -b -3`/Python.h"
cpptestinc "malloc" "stdlib.h" "malloc.h" "malloc/malloc.h" "memory.h"
cpptestinc "libpng" "png.h"
cpptestlib "libpng" "png.h" "-lpng"
cpptestinc "boost preprocessor" "expand.hpp" "boost/expand.hpp" "boost/preprocessor/expand.hpp"

rm common/inc.h 2>/dev/null
for i in $includes; do
	echo "#include <$i>" >> common/inc.h
done

#echo "PYTHON_LIB=-lpython`python --version 2>&1 | awk '{print $2}' | cut -b -3`" >> $config
echo "CFLAGS=\$(CFG_CFLAGS) $incdirs" >> $config
echo "LDFLAGS=\$(CFG_LDFLAGS) $libdirs $libs" >> $config
